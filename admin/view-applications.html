<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - View Job Applications</title>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7f6; padding: 2rem; }
        .container { max-width: 1200px; /* Widened for filter */ margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        
        /* ðŸ‘‡ --- NEW STYLES FOR FILTER --- ðŸ‘‡ */
        .filter-container {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            font-size: 0.9em;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
        }
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            width: 120px; /* Adjust as needed */
        }
        .filter-container button {
            padding: 9px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            margin-top: auto; /* Aligns with bottom of input */
        }
        .filter-button {
            background-color: #007bff;
            color: white;
        }
        .clear-button {
            background-color: #6c757d;
            color: white;
        }
        /* ðŸ‘† --- END OF NEW STYLES --- ðŸ‘† */

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #7b2cbf; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        #loading-message { text-align: center; font-style: italic; color: #777; }
    </style>
</head>
<body>

<div class="container">
    <h1>Student Job Applications</h1>

    <div class="filter-container">
        <div class="filter-group">
            <label for="min-cgpa">Minimum CGPA</label>
            <input type="number" id="min-cgpa" placeholder="E.g., 7.0" step="0.1">
        </div>
        <div class="filter-group">
            <label for="max-cgpa">Maximum CGPA</label>
            <input type="number" id="max-cgpa" placeholder="E.g., 9.0" step="0.1">
        </div>
        <button id="filter-btn" class="filter-button">Filter</button>
        <button id="clear-filter-btn" class="clear-button">Clear</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Student Email</th>
                <th>Company</th>
                <th>Job Title</th>
                <th>CGPA</th>
                <th>Application Date</th>
                <th>Resume</th> 
            </tr>
        </thead>
        <tbody id="applications-tbody">
            </tbody>
    </table>
    <p id="loading-message">Loading applications...</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const tableBody = document.getElementById('applications-tbody');
    const loadingMessage = document.getElementById('loading-message');
    
    // Filter elements
    const minCgpaInput = document.getElementById('min-cgpa');
    const maxCgpaInput = document.getElementById('max-cgpa');
    const filterBtn = document.getElementById('filter-btn');
    const clearBtn = document.getElementById('clear-filter-btn');

    let allApplications = []; // Store all applications

    try {
        const response = await fetch('/api/applications');
        if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
        }
        allApplications = await response.json(); // Store in the global var
        
        loadingMessage.style.display = 'none';
        renderTable(allApplications); // Initial render

    } catch (error) {
        console.error('Failed to fetch applications:', error);
        loadingMessage.textContent = 'Error loading applications.';
        loadingMessage.style.color = 'red';
    }

    // Function to render the table with data
    function renderTable(applications) {
        if (applications.length === 0) {
            // Updated colspan to 7
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No applications found.</td></tr>';
            return;
        }

        tableBody.innerHTML = ''; // Clear existing rows
        applications.forEach(app => {
            const row = document.createElement('tr');
            
            const resumeLink = app.resumePath 
                ? `<a href="/${app.resumePath.replace(/\\/g, '/')}" target="_blank">View Resume</a>`
                : 'Not Available';

            // ðŸ‘‡ --- ROW HTML UPDATED --- ðŸ‘‡
            row.innerHTML = `
                <td>${app.studentName || 'N/A'}</td>
                <td>${app.studentEmail || 'N/A'}</td>
                <td>${app.company}</td>
                <td>${app.jobTitle}</td>
                <td>${app.CGPA || 'N/A'}</td> <td>${new Date(app.applicationDate).toLocaleDateString()}</td>
                <td>${resumeLink}</td>
            `;
            // ðŸ‘† --- END --- ðŸ‘†
            tableBody.appendChild(row);
        });
    }

    // Filter button logic
    filterBtn.addEventListener('click', () => {
        const minCgpa = parseFloat(minCgpaInput.value) || 0;
        const maxCgpa = parseFloat(maxCgpaInput.value) || 10; // Default max

        const filteredApps = allApplications.filter(app => {
            const appCgpa = parseFloat(app.CGPA);
            if (isNaN(appCgpa)) return false; // Don't show if CGPA is N/A
            return appCgpa >= minCgpa && appCgpa <= maxCgpa;
        });
        
        renderTable(filteredApps);
    });

    // Clear button logic
    clearBtn.addEventListener('click', () => {
        minCgpaInput.value = '';
        maxCgpaInput.value = '';
        renderTable(allApplications); // Render the full list again
    });
});
</script>

</body>
</html>